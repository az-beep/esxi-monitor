<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ESXi</title>
    <link rel="stylesheet" href="../css/dashboard.css">
</head>
<body>
    <aside class="sidebar">
        <div class="logo">
            <h1>ESXi Monitor</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>
        </div>
        <nav class="menu">
            <a href="dashboard.html" class="menu-item">
                <span class="menu-icon">üìä</span>
                <span>–î–∞—à–±–æ—Ä–¥</span>
            </a>
            <a href="esxi-config.html" class="menu-item active">
                <span class="menu-icon">‚öôÔ∏è</span>
                <span>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</span>
            </a>
            <a href="esxi-audit.html" class="menu-item">
                <span class="menu-icon">üìã</span>
                <span>–ê—É–¥–∏—Ç</span>
            </a>
        </nav>
        <button class="logout-btn" id="logoutBtn">
            <span>–í—ã–π—Ç–∏</span>
        </button>
    </aside>

    <main class="main-content">
        <div class="header">
            <h2>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ESXi —Ö–æ—Å—Ç–∞</h2>
            <div>
                <button class="btn btn-primary" id="syncNow">
                    üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <span id="syncStatus" style="margin-left: 15px; color: #718096;"></span>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-value" id="totalVMs">0</div>
                <div class="stat-label">–í—Å–µ–≥–æ VM</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="runningVMs">0</div>
                <div class="stat-label">–ó–∞–ø—É—â–µ–Ω–æ</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="cpuUsage">0%</div>
                <div class="stat-label">CPU</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="memoryUsage">0%</div>
                <div class="stat-label">–ü–∞–º—è—Ç—å</div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ VM -->
        <div class="card" style="margin-top: 20px;">
            <h3 class="card-title">–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã</h3>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–ò–º—è</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–û–°</th>
                            <th>–í–µ—Ä—Å–∏—è</th>
                            <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="vmTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px; color: #718096;">
                                –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script type="module">
        import api from '../routes/api.js';
        import { logout } from '../routes/auth.js';

        document.getElementById('logoutBtn').addEventListener('click', logout);
        
        async function loadData() {
            try {
                const [vms, metrics] = await Promise.all([
                    api.getAllVMs(),
                    api.getLatestMetrics()
                ]);
                
                updateStats(vms, metrics);
                updateVMTable(vms);
                updateSyncStatus();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            }
        }
        
        function updateStats(vms, metrics) {
            document.getElementById('totalVMs').textContent = vms.length;
            document.getElementById('runningVMs').textContent = 
                vms.filter(vm => vm.status === 'running').length;
            
            if (metrics && metrics.length > 0) {
                const latest = metrics[0];
                document.getElementById('cpuUsage').textContent = 
                    Math.round(latest.cpu || 0) + '%';
                document.getElementById('memoryUsage').textContent = 
                    Math.round(latest.ram || 0) + '%';
            }
        }
        
        function updateVMTable(vms) {
            const tbody = document.getElementById('vmTableBody');
            tbody.innerHTML = '';
            
            if (vms.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 30px; color: #718096;">
                            –ù–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω
                        </td>
                    </tr>
                `;
                return;
            }
            
            vms.forEach(vm => {
                const row = document.createElement('tr');
                const statusClass = vm.status === 'running' ? 'status-running' : 'status-stopped';
                const statusText = vm.status === 'running' ? '–ó–∞–ø—É—â–µ–Ω–∞' : '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
                
                row.innerHTML = `
                    <td><strong>${vm.name}</strong></td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${vm.guestOS || 'N/A'}</td>
                    <td>${vm.version || 'N/A'}</td>
                    <td>${vm.annotation || ''}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateSyncStatus() {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date().toLocaleTimeString()}`;
        }
        
        document.getElementById('syncNow').addEventListener('click', async () => {
            try {
                const response = await fetch('/monitor/sync', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    alert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞');
                    setTimeout(loadData, 3000);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
            }
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É –∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        loadData();
        setInterval(loadData, 30000);
    </script>
</body>
</html>